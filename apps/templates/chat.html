<title>CHAT</title>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
<link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">


<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
<link href="{{ url_for('static', filename='css/minecss.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/minejs.js') }}"></script>
<script type="text/javascript" charset="utf-8">
    var sever_url='http://' + document.domain + ':' + location.port + '/test'
    var user_me=eval("{{user_me|safe}}")
    var user_other=eval("{{user_other|safe}}")
    var room_id;
    $(document).ready(function(){
      //定义初始化函数
      
      var socket = io.connect(sever_url);
      
      //定义起始,比如进入房间等行为
      socket.emit('enter_room',{'user_id1': user_me,'user_id2': user_other})
      
      //定义起始函数对应后端的响应函数比如后端返回的历史记录，打印在方块内
      socket.on('has_enter', function(msg) 
      {
        room_id=msg['room_id'];
        var chat_history=JSON.parse(msg['chat_history']);
        for (var iter in chat_history){
          var new_iter=chat_history[iter];
          for(var p in new_iter){
          if(p==user_me){
          $('#log').append('<div style="text-align:right">' +p+':'+new_iter[p] + '</div>')
          }
          else{$('#log').append('<div >' +p+':'+new_iter[p] + '</div>')}

          }
        }
        var div = document.getElementById('log');
        log.scrollTop = log.scrollHeight;
      });

      //定义监听函数，接受消息
      socket.on('accept_message', function(msg) {
        $('#log').append('<div class="text-father"><div class="text-right">' + msg['publisher']+':'+msg['data'] + '</div></div>');
        if(parseInt(msg['publisher'])==user_other)
          socket.emit('ensure_receive',{'meassge_id':msg['id']})
        var div = document.getElementById('log');
        log.scrollTop = log.scrollHeight;}
        );

      

      //定义在房间内行为
      $('form#send_room').submit(function(event) {
        socket.emit('new_message', {"user_id": user_me,"room_id": room_id,"recevier_id":user_other,'content':$('#room_data').val()});
        return false;
      });
  
    });






</script>
<style>
.col-center-block {
    float: none;
    display: block;
    margin-left: auto;
    margin-right: auto;
}
.log{
   overflow: hidden;
   overflow-y: scroll;
   white-space: nowrap;
   height:100px;
   width:100%;
 }
.log::-webkit-scrollbar {
    width: 0;
}
.text-father{
width:100%;
height:50px;
}
.text-right{
text-align:right;
font-size:20px;
width:auto;
background:#1E90FF;
position:absolute;
right:0;
}




</style>
{% include "common/header.html" %}<!--引入网页的头部模板-->

<div class="text-center" style="margin-top:20px;background:#00BFFF;color:white;height:100px">
    <br>
    <h1 style="margin-top:10px;">{{other_name}}</h1>
</div>
<div class="container">
    <div class="row myCenter">
        <div class="col-xs-12 col-md-10 col-center-block">
            <div id="log" class="log row"></div>
            <hr>
            <form id="send_room" method="POST" action="#" role="form">
                <div class="form-group row">
                    <div class="col-md-10">
                    <input type="text" class="form-control" name="room_data" id="room_data" placeholder="Message">
                    </div>
                    <input type="submit" class="btn btn-success pull-right" value="Send to Room">
                </div>
            </form>
        </div>
    </div>
</div>
